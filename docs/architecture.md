# システムアーキテクチャ図

## 1. 概要

本ドキュメントはKAZIKASHIKAアプリケーションのシステムアーキテクチャを視覚的に記述します。

---

## 2. システム全体像

```
┌─────────────────────────────────────────────────────┐
│                     Users                           │
│              (PC / スマートフォン)                   │
└──────────────────────┬──────────────────────────────┘
                       │ HTTPS
┌──────────────────────▼──────────────────────────────┐
│              CloudFront (CDN)                       │
│  - SSL/TLS証明書 (AWS Certificate Manager)          │
│  - キャッシュ設定                                    │
│  - DDoS保護 (AWS Shield Standard)                   │
└──────────────────────┬──────────────────────────────┘
                       │
          ┌────────────┴────────────┐
          │                         │
┌─────────▼─────────┐    ┌──────────▼──────────┐
│    S3 Bucket      │    │   API Gateway       │
│   (Frontend)      │    │   (HTTP API)        │
│                   │    │  - CORS設定         │
│ - React SPA       │    │  - レート制限       │
│ - 静的ファイル    │    │  - ロギング         │
└───────────────────┘    └──────────┬──────────┘
                                    │
                         ┌──────────▼──────────┐
                         │      Lambda         │
                         │    (Backend)        │
                         │                     │
                         │  - Express Server   │
                         │  - tRPC Router      │
                         │  - Business Logic   │
                         └──────────┬──────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
         ┌──────────▼──────┐ ┌─────▼──────┐ ┌─────▼──────────┐
         │      VPC        │ │  Cognito   │ │ CloudWatch    │
         │                 │ │ User Pools │ │   Logs        │
         │ ┌─────────────┐ │ │            │ │               │
         │ │     RDS     │ │ │ - 認証     │ │ - 監視        │
         │ │(PostgreSQL) │ │ │ - ユーザー │ │ - ログ集約    │
         │ │             │ │ │   管理     │ │               │
         │ └─────────────┘ │ └────────────┘ └───────────────┘
         │                 │
         │ Private Subnet  │
         └─────────────────┘
```

---

## 3. レイヤー別アーキテクチャ

### 3.1 プレゼンテーション層（フロントエンド）

```
┌─────────────────────────────────────────┐
│           React Application             │
├─────────────────────────────────────────┤
│  Pages (features/)                      │
│    - auth/                              │
│    - onboarding/                        │
│    - chores/                            │
│    - dashboard/                         │
├─────────────────────────────────────────┤
│  Components (components/)               │
│    - ui/ (shadcn/ui)                    │
│    - layout/                            │
├─────────────────────────────────────────┤
│  State Management                       │
│    - tRPC + React Query (サーバー状態)  │
│    - Zustand (ローカル状態)             │
├─────────────────────────────────────────┤
│  Libraries                              │
│    - React Router (ルーティング)        │
│    - AWS Amplify (認証)                 │
│    - Tailwind CSS (スタイリング)        │
│    - Recharts (グラフ)                  │
└─────────────────────────────────────────┘
```

### 3.2 アプリケーション層（バックエンド）

```
┌─────────────────────────────────────────┐
│         Express + tRPC Server           │
├─────────────────────────────────────────┤
│  tRPC Routers                           │
│    - auth.ts (認証)                     │
│    - team.ts (チーム管理)               │
│    - chore.ts (家事管理)                │
│    - choreLog.ts (家事記録)             │
│    - dashboard.ts (ダッシュボード)      │
├─────────────────────────────────────────┤
│  Business Logic (services/)             │
│    - teamService                        │
│    - choreService                       │
│    - choreLogService                    │
│    - dashboardService                   │
├─────────────────────────────────────────┤
│  Utilities                              │
│    - cognito.ts (JWT検証)               │
│    - pointCalculator.ts (ポイント計算)  │
│    - dateRange.ts (期間計算)            │
│    - inviteCode.ts (招待コード生成)     │
├─────────────────────────────────────────┤
│  Middleware                             │
│    - errorHandler (エラーハンドリング)  │
│    - context (tRPCコンテキスト)         │
└─────────────────────────────────────────┘
```

### 3.3 データ層

```
┌─────────────────────────────────────────┐
│          Prisma ORM                     │
├─────────────────────────────────────────┤
│  Models                                 │
│    - User                               │
│    - Team                               │
│    - Chore                              │
│    - UserChoreStress                    │
│    - ChoreLog                           │
├─────────────────────────────────────────┤
│       PostgreSQL Database               │
│         (Amazon RDS)                    │
└─────────────────────────────────────────┘
```

---

## 4. 認証フロー

```
┌─────────────┐
│   User      │
└──────┬──────┘
       │
       │ 1. ログイン
       ▼
┌──────────────────┐
│  Frontend        │
│  (Amplify SDK)   │
└──────┬───────────┘
       │
       │ 2. signIn()
       ▼
┌──────────────────────┐
│  Amazon Cognito      │
│  User Pools          │
└──────┬───────────────┘
       │
       │ 3. ID Token発行
       ▼
┌──────────────────────┐
│  Frontend            │
│  (tRPC Client)       │
└──────┬───────────────┘
       │
       │ 4. Authorization: Bearer <token>
       ▼
┌──────────────────────┐
│  Backend             │
│  (tRPC Context)      │
└──────┬───────────────┘
       │
       │ 5. JWT検証
       ▼
┌──────────────────────┐
│  Cognito JWT Verify  │
└──────┬───────────────┘
       │
       │ 6. Cognito Sub取得
       ▼
┌──────────────────────┐
│  Prisma              │
│  User.findUnique()   │
└──────┬───────────────┘
       │
       │ 7. ユーザー情報をコンテキストに格納
       ▼
┌──────────────────────┐
│  Business Logic      │
│  実行                │
└──────────────────────┘
```

---

## 5. データフロー

### 5.1 家事記録フロー

```
┌────────┐  1. 「完了」ボタンクリック  ┌───────────┐
│ User   │─────────────────────────→│ Frontend  │
└────────┘                           └─────┬─────┘
                                           │
                                           │ 2. 時間入力
                                           ▼
                                     ┌───────────┐
                                     │ Modal UI  │
                                     └─────┬─────┘
                                           │
                                           │ 3. tRPC choreLog.create
                                           ▼
                                     ┌───────────────┐
                                     │ Backend       │
                                     │ choreLogRouter│
                                     └─────┬─────────┘
                                           │
                                           │ 4. ストレス度取得
                                           ▼
                                     ┌───────────────┐
                                     │ Prisma        │
                                     │ UserChoreStress│
                                     └─────┬─────────┘
                                           │
                                           │ 5. ポイント計算
                                           ▼
                                     ┌───────────────┐
                                     │ pointCalculator│
                                     │ points = time×stress│
                                     └─────┬─────────┘
                                           │
                                           │ 6. ChoreLog作成
                                           ▼
                                     ┌───────────────┐
                                     │ Prisma        │
                                     │ ChoreLog.create│
                                     └─────┬─────────┘
                                           │
                                           │ 7. 結果返却
                                           ▼
                                     ┌───────────────┐
                                     │ Frontend      │
                                     │ Toast表示     │
                                     └───────────────┘
```

### 5.2 ランキング表示フロー

```
┌────────┐  1. ダッシュボードアクセス  ┌───────────┐
│ User   │─────────────────────────→│ Frontend  │
└────────┘                           └─────┬─────┘
                                           │
                                           │ 2. tRPC dashboard.getRanking
                                           ▼
                                     ┌───────────────┐
                                     │ Backend       │
                                     │ dashboardRouter│
                                     └─────┬─────────┘
                                           │
                                           │ 3. 期間計算
                                           ▼
                                     ┌───────────────┐
                                     │ dateRange     │
                                     │ getDateRange()│
                                     └─────┬─────────┘
                                           │
                                           │ 4. チームメンバー取得
                                           ▼
                                     ┌───────────────┐
                                     │ Prisma        │
                                     │ User.findMany │
                                     │   include:    │
                                     │   choreLogs   │
                                     └─────┬─────────┘
                                           │
                                           │ 5. ポイント集計
                                           ▼
                                     ┌───────────────┐
                                     │ Business Logic│
                                     │ ポイント合計  │
                                     │ ソート        │
                                     │ ランク付け    │
                                     └─────┬─────────┘
                                           │
                                           │ 6. 結果返却
                                           ▼
                                     ┌───────────────┐
                                     │ Frontend      │
                                     │ Recharts表示  │
                                     └───────────────┘
```

---

## 6. デプロイメントアーキテクチャ

```
┌─────────────────────────────────────────────┐
│         GitHub Repository                   │
└──────────────────┬──────────────────────────┘
                   │
                   │ git push
                   ▼
┌─────────────────────────────────────────────┐
│         GitHub Actions                      │
│                                             │
│  ┌─────────────┐  ┌──────────────┐         │
│  │ Backend CI  │  │ Frontend CI  │         │
│  │             │  │              │         │
│  │ - Lint      │  │ - Lint       │         │
│  │ - Test      │  │ - Test       │         │
│  │ - Build     │  │ - Build      │         │
│  └──────┬──────┘  └──────┬───────┘         │
│         │                │                  │
│         │                │                  │
└─────────┼────────────────┼──────────────────┘
          │                │
          │                │
          ▼                ▼
┌─────────────────┐  ┌─────────────────┐
│   AWS CDK       │  │   AWS CDK       │
│   Backend       │  │   Frontend      │
│   Deploy        │  │   Deploy        │
└─────────┬───────┘  └─────────┬───────┘
          │                    │
          ▼                    ▼
┌─────────────────┐  ┌─────────────────┐
│  Lambda         │  │  S3 + CloudFront│
└─────────────────┘  └─────────────────┘
```

---

## 7. セキュリティアーキテクチャ

```
┌─────────────────────────────────────────────┐
│              CloudFront                     │
│  - AWS Shield Standard (DDoS保護)           │
│  - SSL/TLS暗号化                            │
└──────────────────┬──────────────────────────┘
                   │ HTTPS
┌──────────────────▼──────────────────────────┐
│           API Gateway                       │
│  - CORS設定                                 │
│  - レート制限                               │
│  - アクセスログ                             │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│              Lambda                         │
│  - JWT検証 (aws-jwt-verify)                 │
│  - 環境変数 (Secrets Manager経由)           │
│  - IAMロール（最小権限）                    │
└──────────────────┬──────────────────────────┘
                   │
         ┌─────────┼─────────┐
         │         │         │
┌────────▼───┐ ┌──▼──────┐ ┌▼──────────┐
│  Cognito   │ │  VPC    │ │CloudWatch │
│            │ │         │ │  Logs     │
│ - パスワード│ │ ┌─────┐ │ │           │
│   ハッシュ化│ │ │ RDS │ │ │ - 監査    │
│ - JWT発行  │ │ └─────┘ │ │ - アラート│
└────────────┘ │         │ └───────────┘
               │ Private │
               │ Subnet  │
               └─────────┘
```

### セキュリティレイヤー

1. **ネットワークレイヤー**
   - CloudFront（DDoS保護、SSL/TLS）
   - VPC（ネットワーク分離）
   - セキュリティグループ（最小限のポート開放）

2. **認証・認可レイヤー**
   - Cognito User Pools（認証）
   - JWT検証（認可）
   - チームベースアクセス制御

3. **アプリケーションレイヤー**
   - Zod（入力バリデーション）
   - Prisma（SQLインジェクション対策）
   - React（XSS対策）

4. **データレイヤー**
   - RDS暗号化
   - バックアップ（7日間保持）
   - Secrets Manager（認証情報管理）

---

## 8. モニタリングアーキテクチャ

```
┌─────────────────────────────────────────────┐
│           Application Components            │
│                                             │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │Lambda    │  │RDS       │  │Cognito   │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
│       │             │             │         │
└───────┼─────────────┼─────────────┼─────────┘
        │             │             │
        └─────────────┼─────────────┘
                      │
           ┌──────────▼──────────┐
           │   CloudWatch        │
           │                     │
           │  - Logs             │
           │  - Metrics          │
           │  - Alarms           │
           └──────────┬──────────┘
                      │
           ┌──────────▼──────────┐
           │   Notifications     │
           │                     │
           │  - SNS              │
           │  - Email            │
           └─────────────────────┘
```

### 監視項目

1. **Lambda**
   - 実行時間
   - エラー率
   - 同時実行数

2. **RDS**
   - CPU使用率
   - メモリ使用率
   - ストレージ使用量
   - 接続数
   - スロークエリ

3. **API Gateway**
   - リクエスト数
   - レイテンシー
   - エラー率

4. **CloudFront**
   - キャッシュヒット率
   - リクエスト数
   - エラー率

---

## 9. スケーラビリティ戦略

### 9.1 現在のアーキテクチャ（初期〜100ユーザー）

```
┌──────────────────┐
│  CloudFront      │
│  (CDN)           │
└────────┬─────────┘
         │
┌────────▼─────────┐
│  Lambda          │
│  (512MB)         │
└────────┬─────────┘
         │
┌────────▼─────────┐
│  RDS             │
│  (db.t3.micro)   │
└──────────────────┘
```

### 9.2 将来のスケーリング（1000+ユーザー）

```
┌──────────────────────────┐
│  CloudFront (CDN)        │
└────────┬─────────────────┘
         │
┌────────▼─────────────────┐
│  API Gateway             │
│  (Auto Scaling)          │
└────────┬─────────────────┘
         │
┌────────▼─────────────────┐
│  Lambda (1GB+)           │
│  Provisioned Concurrency │
└────────┬─────────────────┘
         │
    ┌────┴─────┐
    │          │
┌───▼──┐  ┌───▼────┐
│Redis │  │RDS     │
│Cache │  │Primary │
└──────┘  └───┬────┘
              │
         ┌────▼─────┐
         │RDS       │
         │Read      │
         │Replica   │
         └──────────┘
```

---

## 10. 技術スタック一覧

### フロントエンド
| 技術 | バージョン | 用途 |
|-----|-----------|------|
| React | 18.x | UIフレームワーク |
| Vite | 6.x | ビルドツール |
| TypeScript | 5.x | 型安全性 |
| tRPC | 10.x | API通信 |
| TanStack Query | 5.x | サーバー状態管理 |
| Zustand | 4.x | クライアント状態管理 |
| React Router | 6.x | ルーティング |
| AWS Amplify | 6.x | 認証 |
| Tailwind CSS | 3.x | スタイリング |
| shadcn/ui | latest | UIコンポーネント |
| Recharts | 2.x | グラフ描画 |
| React Hook Form | 7.x | フォーム管理 |
| Zod | 3.x | バリデーション |
| Vitest | 1.x | テスト |

### バックエンド
| 技術 | バージョン | 用途 |
|-----|-----------|------|
| Node.js | 20.x | ランタイム |
| Express | 4.x | サーバーフレームワーク |
| TypeScript | 5.x | 型安全性 |
| tRPC | 10.x | API実装 |
| Prisma | 5.x | ORM |
| Zod | 3.x | バリデーション |
| aws-jwt-verify | 4.x | JWT検証 |
| nanoid | 5.x | ID生成 |
| Vitest | 1.x | テスト |

### インフラ
| 技術 | バージョン | 用途 |
|-----|-----------|------|
| AWS CDK | 2.x | IaC |
| AWS Lambda | Node.js 20.x | サーバーレス実行 |
| Amazon RDS | PostgreSQL 15.x | データベース |
| Amazon Cognito | - | 認証 |
| Amazon S3 | - | 静的ホスティング |
| CloudFront | - | CDN |
| API Gateway | HTTP API | APIゲートウェイ |
| CloudWatch | - | 監視・ログ |

### 開発ツール
| 技術 | バージョン | 用途 |
|-----|-----------|------|
| npm | 10.x | パッケージ管理 |
| Biome | latest | Linter/Formatter |
| GitHub Actions | - | CI/CD |

---

## 11. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|-----|----------|---------|-------|
| 2025-10-05 | 1.0 | 初版作成 | - |

